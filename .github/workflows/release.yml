name: Release Socks Server (Ubuntu 20.04)

on:
  push:
    tags:
      - 'v*' # 匹配以 'v' 开头的标签，例如 v1.0.0

jobs:
  build:
    runs-on: ${{ matrix.os }} # 使用矩阵策略
    strategy:
      matrix:
        os: [ubuntu-20.04, ubuntu-22.04, ubuntu-18.04, windows-latest] # 支持的平台
        include:
          - os: ubuntu-20.04
            release_name: ubuntu-20.04
            artifact_name: socks-server-${{ github.ref }}-ubuntu-20.04.tar.gz
            binary_name: socks-server
            package_command: tar -czvf ${{ matrix.artifact_name }} -C release .
          - os: ubuntu-22.04
            release_name: ubuntu-22.04
            artifact_name: socks-server-${{ github.ref }}-ubuntu-22.04.tar.gz
            binary_name: socks-server
            package_command: tar -czvf ${{ matrix.artifact_name }} -C release .
          - os: ubuntu-18.04
            release_name: ubuntu-18.04
            artifact_name: socks-server-${{ github.ref }}-ubuntu-18.04.tar.gz
            binary_name: socks-server
            package_command: tar -czvf ${{ matrix.artifact_name }} -C release .
          - os: windows-latest
            release_name: windows-latest
            artifact_name: socks-server-${{ github.ref }}-windows-x64.zip
            binary_name: socks-server.exe
            package_command: 7z a ${{ matrix.artifact_name }} .\release\*

    steps:
    # 1. 检出代码
    - name: Checkout code
      uses: actions/checkout@v3

    # 2. 安装构建工具
    - name: Install dependencies
      run: |
        if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
          choco install cmake --installargs 'ADD_CMAKE_TO_PATH=System'
          choco install 7zip
        else
          sudo apt-get update
          sudo apt-get install -y build-essential cmake
        fi

    # 3. 构建项目
    - name: Build
      run: |
        mkdir -p build
        cd build
        if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
          cmake -G "Visual Studio 16 2019" -DCMAKE_BUILD_TYPE=Release ..
          cmake --build . --config Release
        else
          cmake -DCMAKE_BUILD_TYPE=Release ..
          make -j
        fi

    # 4. 创建发布
    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ github.ref }} (${{ matrix.release_name }})
        draft: false
        prerelease: false

    # 5. 打包 /bin/socks-server 和 config.json
    - name: Package Binary and Config
      run: |
        mkdir -p release/bin
        cp ./bin/${{ matrix.binary_name }} release/bin/${{ matrix.binary_name }}
        cp ./config.json release/
        ${{ matrix.package_command }}

    # 6. 上传打包文件到 GitHub Releases
    - name: Upload Package
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./${{ matrix.artifact_name }}
        asset_name: ${{ matrix.artifact_name }}
        asset_content_type: application/octet-stream